{% extends "base.html" %}

{% load static i18n %}
{% load game_result %}

{% block page_title %}{% translate "Sezon" %} #{{ object.season.number }} - {% translate "Grupa" %}
    {{ object.name }} - {% translate "Wszystkie gry" %}{% endblock %}

{% block content %}
    <div class="row">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url "seasons-list" %}">{% translate "Sezony" %}</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url "season-detail" object.season.number %}">
                            {% translate "Sezon" %} #{{ object.season.number }}
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url "group-detail" season_number=object.season.number group_name=object.name %}">
                            {% translate "Grupa" %} {{ object.name }}
                        </a>
                    </li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between mb-2">
                <h3>{% translate "Wszystkie gry" %} - {% translate "Grupa Nauczycielska" %} {{ object.name }}</h3>
                <div class="d-flex align-items-center">
                    <div>
                        <a href="{% url 'group-games' season_number=object.season.number group_name=object.name %}" class="btn btn-sm btn-primary me-1">
                            <i class="fa fa-list"></i> {% translate "Widok rund" %}
                        </a>
                        <a href="{% url 'group-detail' season_number=object.season.number group_name=object.name %}" class="btn btn-sm btn-secondary">
                            <i class="fa fa-arrow-left"></i> {% translate "Grupa Nauczycielska" %}
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="mb-3 p-3 bg-light rounded">
                <div class="form-label fw-bold mb-2">{% translate "Grupuj dla Nauczycieli" %}:</div>
                <div id="group-selectors" class="d-flex flex-wrap align-items-center gap-2">
                    <div class="d-flex align-items-center group-selector">
                        <label for="groupSize-1" class="me-2 mb-0">{% translate "Grupa" %} 1:</label>
                        <select id="groupSize-1" class="form-select group-size-select" style="width: auto;">
                            <option value="0">{% translate "Brak" %}</option>
                            {% for i in group_options %}
                                <option value="{{ i }}">{{ i }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-group-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-2 text-muted">
                    {% translate "Wybierz liczbę gier w grupach dla łatwego przydzielenia zadań nauczycielskich. Kolejne grupy będą dodawane automatycznie." %}
                </div>
            </div>

            <table class="table table-sm table-hover table-striped">
                <thead class="table-light">
                    <tr>
                        <th>R</th>
                        <th>{% translate "Czarny" %}</th>
                        <th>{% translate "Biały" %}</th>
                        <th>{% translate "Wynik" %}</th>
                        <th>{% translate "Data" %}</th>
                        <th>{% translate "Recenzja" %}</th>
                        <th>{% translate "Akcje" %}</th>
                        <th class="group-column text-center bg-primary text-white" style="display: none;">{% translate "Grupa Nauczycielska" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in all_games %}
                        <tr>
                            <td>{{ game.round.number }}</td>
                            <td>
                                <a href="{{ game.black.player.get_absolute_url }}">
                                    {{ game.black.player.nick }} ({{ game.black.rank }})
                                </a>
                                {% if game.black.player.is_supporter %}
                                    <span class="badge bg-warning text-dark ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate "Ten gracz jest patronem IGLO!" %}">
                                        <i class="fas fa-award"></i> Patron
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ game.white.player.get_absolute_url }}">
                                    {{ game.white.player.nick }} ({{ game.white.rank }})
                                </a>
                                {% if game.white.player.is_supporter %}
                                    <span class="badge bg-warning text-dark ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate "Ten gracz jest patronem IGLO!" %}">
                                        <i class="fas fa-award"></i> Patron
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if game.is_played %}
                                    {{ game | result }}
                                {% else %}
                                    -
                                {% endif %}
                                {% if game.is_egd_eligible %}
                                    <span class="badge bg-info ms-1" title="{% translate 'This game is eligible for EGD export' %}">EGD</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ game.date|date:"Y-m-d" }}
                                {% if game.is_delayed %}
                                    <i class="fas fa-exclamation-triangle text-danger"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if game.review_video_link %}
                                    <a href="{{ game.review_video_link }}" target="_blank" class="badge bg-success text-decoration-none">
                                        <i class="fas fa-video"></i> {% translate "Zobacz recenzję" %}
                                    </a>
                                {% else %}
                                    <span class="text-muted">{% translate "Brak recenzji" %}</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ game.get_absolute_url }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                            <td class="group-column text-center fw-bold" style="display: none;"></td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">{% translate "Brak gier w tej grupie." %}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const groupSelectorsContainer = document.getElementById('group-selectors');
            const gameRows = document.querySelectorAll('tbody tr');
            const groupColumns = document.querySelectorAll('.group-column');
            const groupColors = [
                'rgba(255, 99, 132, 0.2)',   // Red
                'rgba(54, 162, 235, 0.2)',   // Blue
                'rgba(255, 206, 86, 0.2)',   // Yellow
                'rgba(75, 192, 192, 0.2)',   // Teal
                'rgba(153, 102, 255, 0.2)',  // Purple
                'rgba(255, 159, 64, 0.2)',   // Orange
                'rgba(199, 199, 199, 0.2)',  // Grey
                'rgba(83, 123, 156, 0.2)',   // Blue Grey
                'rgba(172, 212, 89, 0.2)',   // Light Green
                'rgba(250, 160, 160, 0.2)'   // Light Red
            ];
            
            // Enable tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Group options data for new selects
            const groupOptions = [
                { value: "0", text: "{% translate "Brak" %}" }
            ];
            {% for i in group_options %}
                groupOptions.push({ value: "{{ i }}", text: "{{ i }}" });
            {% endfor %}
            
            // Create a new group size selector
            function createGroupSelector(groupNumber) {
                const selector = document.createElement('div');
                selector.className = 'd-flex align-items-center group-selector';
                
                const label = document.createElement('label');
                label.setAttribute('for', `groupSize-${groupNumber}`);
                label.className = 'me-2 mb-0';
                label.textContent = `{% translate "Grupa" %} ${groupNumber}:`;
                
                const select = document.createElement('select');
                select.id = `groupSize-${groupNumber}`;
                select.className = 'form-select group-size-select';
                select.style.width = 'auto';
                
                // Add options
                groupOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    select.appendChild(option);
                });
                
                // Create remove button
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger ms-2 remove-group-btn';
                if (groupNumber === 1) {
                    removeBtn.style.display = 'none';
                }
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-times';
                removeBtn.appendChild(icon);
                
                // Add event listener for remove button
                removeBtn.addEventListener('click', function() {
                    selector.remove();
                    renumberGroups();
                    applyGrouping();
                });
                
                // Add event listener for select
                select.addEventListener('change', function() {
                    handleSelectChange(select);
                    applyGrouping();
                });
                
                selector.appendChild(label);
                selector.appendChild(select);
                selector.appendChild(removeBtn);
                
                return selector;
            }
            
            // Renumber group selectors after removal
            function renumberGroups() {
                const selectors = document.querySelectorAll('.group-selector');
                selectors.forEach((selector, index) => {
                    const groupNumber = index + 1;
                    const label = selector.querySelector('label');
                    const select = selector.querySelector('select');
                    
                    label.textContent = `{% translate "Grupa" %} ${groupNumber}:`;
                    label.setAttribute('for', `groupSize-${groupNumber}`);
                    select.id = `groupSize-${groupNumber}`;
                    
                    // Hide remove button on first group
                    const removeBtn = selector.querySelector('.remove-group-btn');
                    if (groupNumber === 1) {
                        removeBtn.style.display = 'none';
                    } else {
                        removeBtn.style.display = '';
                    }
                });
            }
            
            // Handle select change - add new selector if last one is not 0
            function handleSelectChange(select) {
                const selectors = document.querySelectorAll('.group-selector');
                const lastSelector = selectors[selectors.length - 1];
                const lastSelect = lastSelector.querySelector('select');
                
                // If the last selector is set to a non-zero value, add a new selector
                if (lastSelect === select && parseInt(select.value, 10) > 0) {
                    const newGroupNumber = selectors.length + 1;
                    const newSelector = createGroupSelector(newGroupNumber);
                    groupSelectorsContainer.appendChild(newSelector);
                }
            }
            
            // Function to apply group coloring and numbering based on multiple size selectors
            function applyGrouping() {
                // Get all group sizes from selectors
                const groupSizes = [];
                const selectors = document.querySelectorAll('.group-size-select');
                selectors.forEach(select => {
                    const size = parseInt(select.value, 10);
                    if (size > 0) {
                        groupSizes.push(size);
                    }
                });
                
                // Reset all row backgrounds and hide group columns
                gameRows.forEach(row => {
                    row.style.backgroundColor = '';
                });
                
                groupColumns.forEach(col => {
                    col.style.display = 'none';
                });
                
                // If no valid group sizes, exit early
                if (groupSizes.length === 0) return;
                
                // Show group columns
                groupColumns.forEach(col => {
                    col.style.display = '';
                });
                
                // Apply colors and group numbers for each game
                let currentIndex = 0;
                let currentGroupNumber = 1;
                
                for (let size of groupSizes) {
                    for (let i = 0; i < size && currentIndex < gameRows.length; i++) {
                        const row = gameRows[currentIndex];
                        if (row.cells.length > 1) { // Skip "No games" row if present
                            const colorIndex = (currentGroupNumber - 1) % groupColors.length;
                            
                            // Set background color
                            row.style.backgroundColor = groupColors[colorIndex];
                            
                            // Set group number
                            const groupCell = row.querySelector('.group-column');
                            if (groupCell) {
                                groupCell.textContent = currentGroupNumber;
                            }
                            
                            currentIndex++;
                        }
                    }
                    currentGroupNumber++;
                }
                
                // Handle remaining games if any
                while (currentIndex < gameRows.length) {
                    const row = gameRows[currentIndex];
                    if (row.cells.length > 1) {
                        row.style.backgroundColor = ''; // No color for ungrouped games
                        
                        const groupCell = row.querySelector('.group-column');
                        if (groupCell) {
                            groupCell.textContent = '?'; // Mark as ungrouped
                        }
                        
                        currentIndex++;
                    }
                }
            }
            
            // Initialize event listeners for existing elements
            const initialSelect = document.querySelector('.group-size-select');
            if (initialSelect) {
                initialSelect.addEventListener('change', function() {
                    handleSelectChange(initialSelect);
                    applyGrouping();
                });
            }
        });
    </script>
{% endblock %}