{% extends "base.html" %}

{% load static i18n %}
{% load game_result %}

{% block page_title %}{% translate "Sezon" %} #{{ object.season.number }} - {% translate "Grupa" %}
    {{ object.name }} - {% translate "Wszystkie gry" %}{% endblock %}

{% block content %}
    <div class="row">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url "seasons-list" %}">{% translate "Sezony" %}</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url "season-detail" object.season.number %}">
                            {% translate "Sezon" %} #{{ object.season.number }}
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url "group-detail" season_number=object.season.number group_name=object.name %}">
                            {% translate "Grupa" %} {{ object.name }}
                        </a>
                    </li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between mb-2">
                <h3>{% translate "Wszystkie gry" %} - {% translate "Grupa Nauczycielska" %} {{ object.name }}</h3>
                <div class="d-flex align-items-center">
                    <div>
                        <a href="{% url 'group-games' season_number=object.season.number group_name=object.name %}" class="btn btn-sm btn-primary me-1">
                            <i class="fa fa-list"></i> {% translate "Widok rund" %}
                        </a>
                        <a href="{% url 'group-detail' season_number=object.season.number group_name=object.name %}" class="btn btn-sm btn-secondary">
                            <i class="fa fa-arrow-left"></i> {% translate "Grupa Nauczycielska" %}
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="mb-3 p-3 bg-light rounded">
                <div class="form-label fw-bold mb-2">{% translate "Przypisz nauczycieli do grup" %}:</div>
                <div id="group-selectors" class="d-flex flex-column gap-2">
                    <div class="d-flex align-items-center group-selector">
                        <div class="row w-100 align-items-center">
                            <div class="col-auto">
                                <label for="groupSize-1" class="me-2 mb-0">{% translate "Grupa" %} 1:</label>
                            </div>
                            <div class="col-md-2">
                                <select id="groupSize-1" class="form-select group-size-select">
                                    <option value="0">{% translate "Brak" %}</option>
                                    {% for i in group_options %}
                                        <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">{% translate "Nauczyciel" %}</span>
                                    <input type="text" class="form-control teacher-name" placeholder="{% translate "Imię i nazwisko" %}">
                                </div>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-group-btn" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" id="add-group-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus"></i> {% translate "Dodaj grupę" %}
                    </button>
                    <span class="ms-3 text-muted">
                        {% translate "Przypisz liczbę gier w grupie i odpowiedzialnego nauczyciela." %}
                    </span>
                </div>
                <div class="mt-2 alert alert-info small">
                    <i class="fas fa-info-circle me-1"></i> 
                    {% translate "URL strony jest aktualizowany automatycznie i może być skopiowany i udostępniony innym. Konfiguracja nie jest zapisywana w bazie danych." %}
                </div>
            </div>

            <table class="table table-sm table-hover table-striped">
                <thead class="table-light">
                    <tr>
                        <th>R</th>
                        <th>{% translate "Czarny" %}</th>
                        <th>{% translate "Biały" %}</th>
                        <th>{% translate "Wynik" %}</th>
                        <th>{% translate "Data" %}</th>
                        <th>{% translate "Recenzja" %}</th>
                        <th>{% translate "Akcje" %}</th>
                        <th class="group-column text-center bg-primary text-white" style="display: none;">{% translate "Nauczyciel" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in all_games %}
                        <tr>
                            <td>{{ game.round.number }}</td>
                            <td>
                                <a href="{{ game.black.player.get_absolute_url }}">
                                    {{ game.black.player.nick }} ({{ game.black.rank }})
                                </a>
                                {% if game.black.player.is_supporter %}
                                    <span class="badge bg-warning text-dark ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate "Ten gracz jest patronem IGLO!" %}">
                                        <i class="fas fa-award"></i> Patron
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ game.white.player.get_absolute_url }}">
                                    {{ game.white.player.nick }} ({{ game.white.rank }})
                                </a>
                                {% if game.white.player.is_supporter %}
                                    <span class="badge bg-warning text-dark ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate "Ten gracz jest patronem IGLO!" %}">
                                        <i class="fas fa-award"></i> Patron
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if game.is_played %}
                                    {{ game | result }}
                                {% else %}
                                    -
                                {% endif %}
                                {% if game.is_egd_eligible %}
                                    <span class="badge bg-info ms-1" title="{% translate 'This game is eligible for EGD export' %}">EGD</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ game.date|date:"Y-m-d" }}
                                {% if game.is_delayed %}
                                    <i class="fas fa-exclamation-triangle text-danger"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if game.review_video_link %}
                                    <a href="{{ game.review_video_link }}" target="_blank" class="badge bg-success text-decoration-none">
                                        <i class="fas fa-video"></i> {% translate "Zobacz recenzję" %}
                                    </a>
                                {% else %}
                                    <span class="text-muted">{% translate "Brak recenzji" %}</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ game.get_absolute_url }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                            <td class="group-column text-center fw-bold" style="display: none;"></td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">{% translate "Brak gier w tej grupie." %}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const groupSelectorsContainer = document.getElementById('group-selectors');
            const addGroupBtn = document.getElementById('add-group-btn');
            const gameRows = document.querySelectorAll('tbody tr');
            const groupColumns = document.querySelectorAll('.group-column');
            const groupColors = [
                'rgba(255, 99, 132, 0.2)',   // Red
                'rgba(54, 162, 235, 0.2)',   // Blue
                'rgba(255, 206, 86, 0.2)',   // Yellow
                'rgba(75, 192, 192, 0.2)',   // Teal
                'rgba(153, 102, 255, 0.2)',  // Purple
                'rgba(255, 159, 64, 0.2)',   // Orange
                'rgba(199, 199, 199, 0.2)',  // Grey
                'rgba(83, 123, 156, 0.2)',   // Blue Grey
                'rgba(172, 212, 89, 0.2)',   // Light Green
                'rgba(250, 160, 160, 0.2)'   // Light Red
            ];
            
            // Enable tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Group options data for new selects
            const groupOptions = [
                { value: "0", text: "{% translate "Brak" %}" }
            ];
            {% for i in group_options %}
                groupOptions.push({ value: "{{ i }}", text: "{{ i }}" });
            {% endfor %}
            
            // Create a new group size selector
            function createGroupSelector(groupNumber, size = 0, teacherName = '') {
                const selector = document.createElement('div');
                selector.className = 'd-flex align-items-center group-selector';
                
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row w-100 align-items-center';
                
                // Label column
                const labelCol = document.createElement('div');
                labelCol.className = 'col-auto';
                
                const label = document.createElement('label');
                label.setAttribute('for', `groupSize-${groupNumber}`);
                label.className = 'me-2 mb-0';
                label.textContent = `{% translate "Grupa" %} ${groupNumber}:`;
                
                labelCol.appendChild(label);
                
                // Select column
                const selectCol = document.createElement('div');
                selectCol.className = 'col-md-2';
                
                const select = document.createElement('select');
                select.id = `groupSize-${groupNumber}`;
                select.className = 'form-select group-size-select';
                
                // Add options
                groupOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (opt.value === size.toString()) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                selectCol.appendChild(select);
                
                // Teacher name column
                const teacherCol = document.createElement('div');
                teacherCol.className = 'col-md-4';
                
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                
                const inputGroupText = document.createElement('span');
                inputGroupText.className = 'input-group-text';
                inputGroupText.textContent = '{% translate "Nauczyciel" %}';
                
                const teacherInput = document.createElement('input');
                teacherInput.type = 'text';
                teacherInput.className = 'form-control teacher-name';
                teacherInput.placeholder = '{% translate "Imię i nazwisko" %}';
                teacherInput.value = teacherName;
                
                inputGroup.appendChild(inputGroupText);
                inputGroup.appendChild(teacherInput);
                teacherCol.appendChild(inputGroup);
                
                // Button column
                const buttonCol = document.createElement('div');
                buttonCol.className = 'col-auto';
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger remove-group-btn';
                if (groupNumber === 1) {
                    removeBtn.style.display = 'none';
                }
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-times';
                removeBtn.appendChild(icon);
                
                buttonCol.appendChild(removeBtn);
                
                // Assemble the row
                rowDiv.appendChild(labelCol);
                rowDiv.appendChild(selectCol);
                rowDiv.appendChild(teacherCol);
                rowDiv.appendChild(buttonCol);
                
                selector.appendChild(rowDiv);
                
                // Add event listeners
                removeBtn.addEventListener('click', function() {
                    selector.remove();
                    renumberGroups();
                    applyGrouping();
                    updateUrl();
                });
                
                select.addEventListener('change', function() {
                    applyGrouping();
                    updateUrl();
                });
                
                teacherInput.addEventListener('input', function() {
                    applyGrouping();
                    // Use debounce for URL update to avoid excessive URL changes while typing
                    debounce(updateUrl, 500)();
                });
                
                return selector;
            }
            
            // Renumber group selectors after removal
            function renumberGroups() {
                const selectors = document.querySelectorAll('.group-selector');
                selectors.forEach((selector, index) => {
                    const groupNumber = index + 1;
                    const label = selector.querySelector('label');
                    const select = selector.querySelector('select');
                    
                    label.textContent = `{% translate "Grupa" %} ${groupNumber}:`;
                    label.setAttribute('for', `groupSize-${groupNumber}`);
                    select.id = `groupSize-${groupNumber}`;
                    
                    // Hide remove button on first group
                    const removeBtn = selector.querySelector('.remove-group-btn');
                    if (groupNumber === 1) {
                        removeBtn.style.display = 'none';
                    } else {
                        removeBtn.style.display = '';
                    }
                });
            }
            
            // Debounce function to limit frequency of URL updates
            function debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(function() {
                        func.apply(context, args);
                    }, wait);
                };
            }
            
            // Update URL with current group configuration
            function updateUrl() {
                const groups = getGroupsData();
                
                // Create URL parameters
                const params = new URLSearchParams(window.location.search);
                
                // Clear existing group params
                Array.from(params.keys()).forEach(key => {
                    if (key.startsWith('g') || key.startsWith('t')) {
                        params.delete(key);
                    }
                });
                
                // Add new group params
                groups.forEach((group, index) => {
                    params.set(`g${index + 1}`, group.size);
                    if (group.teacher) {
                        params.set(`t${index + 1}`, encodeURIComponent(group.teacher));
                    }
                });
                
                // Update URL without reloading the page
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.replaceState({ path: newUrl }, '', newUrl);
            }
            
            // Extract group data from URL parameters
            function getGroupsFromUrl() {
                const params = new URLSearchParams(window.location.search);
                const groups = [];
                
                // Scan for group size parameters (g1, g2, etc.)
                let groupIndex = 1;
                while (params.has(`g${groupIndex}`)) {
                    const size = parseInt(params.get(`g${groupIndex}`), 10);
                    const teacher = params.has(`t${groupIndex}`) ? 
                        decodeURIComponent(params.get(`t${groupIndex}`)) : '';
                    
                    if (size > 0) {
                        groups.push({ size, teacher });
                    }
                    
                    groupIndex++;
                }
                
                return groups;
            }
            
            // Add group button handler
            addGroupBtn.addEventListener('click', function() {
                const newGroupNumber = document.querySelectorAll('.group-selector').length + 1;
                const newSelector = createGroupSelector(newGroupNumber);
                groupSelectorsContainer.appendChild(newSelector);
                updateUrl();
            });
            
            // Share button - generate shareable URL
            function addShareButton() {
                const controlsDiv = document.querySelector('.mb-3.p-3.bg-light.rounded');
                
                // Create share button if it doesn't exist
                if (!document.getElementById('share-groups-btn')) {
                    const shareBtn = document.createElement('button');
                    shareBtn.id = 'share-groups-btn';
                    shareBtn.className = 'btn btn-sm btn-outline-info ms-2';
                    shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> {% translate "Kopiuj link" %}';
                    shareBtn.addEventListener('click', function() {
                        // Create a temporary input to copy the URL
                        const tempInput = document.createElement('input');
                        tempInput.value = window.location.href;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        
                        // Visual feedback
                        shareBtn.innerHTML = '<i class="fas fa-check"></i> {% translate "Skopiowano!" %}';
                        setTimeout(() => {
                            shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> {% translate "Kopiuj link" %}';
                        }, 2000);
                    });
                    
                    // Add button next to "Add Group" button
                    const buttonContainer = document.querySelector('.mt-3');
                    buttonContainer.appendChild(shareBtn);
                }
            }
            
            // Get groups data from the UI
            function getGroupsData() {
                const groups = [];
                const selectors = document.querySelectorAll('.group-selector');
                
                selectors.forEach((selector, index) => {
                    const sizeSelect = selector.querySelector('.group-size-select');
                    const teacherInput = selector.querySelector('.teacher-name');
                    
                    const size = parseInt(sizeSelect.value, 10);
                    const teacherName = teacherInput.value.trim();
                    
                    if (size > 0) {
                        groups.push({
                            groupNumber: index + 1,
                            size: size,
                            teacher: teacherName
                        });
                    }
                });
                
                return groups;
            }
            
            // Function to apply group coloring and display teacher names
            function applyGrouping() {
                // Get group data
                const groups = getGroupsData();
                
                // Reset all row backgrounds and hide group columns
                gameRows.forEach(row => {
                    row.style.backgroundColor = '';
                });
                
                groupColumns.forEach(col => {
                    col.style.display = 'none';
                });
                
                // If no valid groups, exit early
                if (groups.length === 0) return;
                
                // Show group columns
                groupColumns.forEach(col => {
                    col.style.display = '';
                });
                
                // Apply colors and teacher names for each game
                let currentIndex = 0;
                
                for (let group of groups) {
                    for (let i = 0; i < group.size && currentIndex < gameRows.length; i++) {
                        const row = gameRows[currentIndex];
                        if (row.cells.length > 1) { // Skip "No games" row if present
                            const colorIndex = (group.groupNumber - 1) % groupColors.length;
                            
                            // Set background color
                            row.style.backgroundColor = groupColors[colorIndex];
                            
                            // Set teacher name
                            const groupCell = row.querySelector('.group-column');
                            if (groupCell) {
                                groupCell.textContent = group.teacher || `{% translate "Grupa" %} ${group.groupNumber}`;
                            }
                            
                            currentIndex++;
                        }
                    }
                }
                
                // Handle remaining games if any
                while (currentIndex < gameRows.length) {
                    const row = gameRows[currentIndex];
                    if (row.cells.length > 1) {
                        row.style.backgroundColor = ''; // No color for ungrouped games
                        
                        const groupCell = row.querySelector('.group-column');
                        if (groupCell) {
                            groupCell.textContent = '-'; // Mark as ungrouped
                        }
                        
                        currentIndex++;
                    }
                }
            }
            
            // Initialize from URL or create default first group
            function initializeGroups() {
                // Clear existing groups
                groupSelectorsContainer.innerHTML = '';
                
                // Check if we have groups in the URL
                const urlGroups = getGroupsFromUrl();
                
                if (urlGroups.length > 0) {
                    // Create groups from URL parameters
                    urlGroups.forEach((group, index) => {
                        const groupNumber = index + 1;
                        const selector = createGroupSelector(groupNumber, group.size, group.teacher);
                        groupSelectorsContainer.appendChild(selector);
                    });
                } else {
                    // Create default first group
                    const selector = createGroupSelector(1);
                    groupSelectorsContainer.appendChild(selector);
                }
                
                // Apply grouping
                applyGrouping();
                
                // Add share button
                addShareButton();
            }
            
            // Initialize everything
            initializeGroups();
        });
    </script>
{% endblock %}